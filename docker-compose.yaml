services:
    app:
        build:
            context: .
            dockerfile: docker/frankenphp/Dockerfile
            target: dev
            args:
                FRANKENPHP_VERSION: "1.3.4"
                PHP_VERSION: "8.4"
                PHP_EXTENSIONS: "intl pdo_pgsql zip opcache sodium xml"
                PECL_EXTENSIONS: ""
                APK_PACKAGES: "postgresql-dev icu-dev libzip-dev"
        container_name: symfony_app_dev
        hostname: app
        ports:
            - "8080:80"
            - "8443:443"
            - "2019:2019"
        volumes:
            - ./:/app:cached
            - /app/var/cache
        env_file:
            - .env
        environment:
            - APP_ENV=dev
            - XDEBUG_MODE=debug
            - PHP_IDE_CONFIG=serverName=app
        extra_hosts:
            - "host.docker.internal:host-gateway"
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost/health" ]
            interval: 30s
            timeout: 3s
            retries: 3
            start_period: 40s
        networks:
            - symfony_network
        depends_on:
            database:
                condition: service_healthy

    database:
        image: postgres:${POSTGRES_VERSION:-16}-alpine
        container_name: symfony_db_dev
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-app}
            POSTGRES_USER: ${POSTGRES_USER:-app}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secret}
        healthcheck:
            test: ["CMD", "pg_isready", "-d", "${POSTGRES_DB:-app}", "-U", "${POSTGRES_USER:-app}"]
            timeout: 5s
            retries: 5
            start_period: 60s
        volumes:
            - database_data_dev:/var/lib/postgresql/data:rw
        ports:
            - "${POSTGRES_PORT:-5432}:5432"
        networks:
            - symfony_network

volumes:
    database_data_dev:

networks:
    symfony_network:
        driver: bridge
