name: CI/CD

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        name: Build Docker Images
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Copy env file
                run: cp .env.dist .env

            -   name: Build dev image
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: docker/frankenphp/Dockerfile
                    target: dev
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                        PECL_EXTENSIONS=
                        APK_PACKAGES=postgresql-dev icu-dev libzip-dev git unzip
                    tags: symfony-app:dev
                    load: true
                    cache-from: type=gha,scope=dev-${{ github.ref_name }}
                    cache-to: type=gha,scope=dev-${{ github.ref_name }},mode=max

            -   name: Build prod image
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: docker/frankenphp/Dockerfile
                    target: prod
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                    tags: symfony-app:prod
                    load: true
                    cache-from: type=gha,scope=prod-${{ github.ref_name }}
                    cache-to: type=gha,scope=prod-${{ github.ref_name }},mode=max

    phpstan:
        name: PHPStan
        needs: build
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Copy env file
                run: cp .env.dist .env

            -   name: Build dev image with cache
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: docker/frankenphp/Dockerfile
                    target: dev
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                        PECL_EXTENSIONS=
                        APK_PACKAGES=postgresql-dev icu-dev libzip-dev git unzip
                    tags: symfony-app:dev
                    load: true
                    cache-from: type=gha,scope=dev-${{ github.ref_name }}

            -   name: Start environment
                run: docker compose -f docker-compose.test.yaml up -d

            -   name: Install dependencies
                run: |
                    docker compose -f docker-compose.test.yaml exec -T app composer install --no-interaction --prefer-dist
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console transfer:generate
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:clear --no-warmup
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:warmup

            -   name: Run PHPStan
                run: docker compose -f docker-compose.test.yaml exec -T app vendor/bin/phpstan analyse --memory-limit=1G

            -   name: Stop environment
                if: always()
                run: docker compose -f docker-compose.test.yaml down -v

    deptrac:
        name: Deptrac
        needs: build
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Copy env file
                run: cp .env.dist .env

            -   name: Build dev image with cache
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: docker/frankenphp/Dockerfile
                    target: dev
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                        PECL_EXTENSIONS=
                        APK_PACKAGES=postgresql-dev icu-dev libzip-dev git unzip
                    tags: symfony-app:dev
                    load: true
                    cache-from: type=gha,scope=dev-${{ github.ref_name }}

            -   name: Start environment
                run: docker compose -f docker-compose.test.yaml up -d

            -   name: Install dependencies
                run: |
                    docker compose -f docker-compose.test.yaml exec -T app composer install --no-interaction --prefer-dist
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console transfer:generate
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:clear --no-warmup
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:warmup

            -   name: Run Deptrac
                run: docker compose -f docker-compose.test.yaml exec -T app vendor/bin/deptrac

            -   name: Stop environment
                if: always()
                run: docker compose -f docker-compose.test.yaml down -v

    test:
        name: PHPUnit
        runs-on: ubuntu-latest
        needs: [ deptrac, phpstan ]
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Copy env file
                run: cp .env.dist .env

            -   name: Build dev image with cache
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: docker/frankenphp/Dockerfile
                    target: dev
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                        PECL_EXTENSIONS=
                        APK_PACKAGES=postgresql-dev icu-dev libzip-dev git unzip
                    tags: symfony-app:dev
                    load: true
                    cache-from: type=gha,scope=dev-${{ github.ref_name }}

            -   name: Start environment
                run: docker compose -f docker-compose.test.yaml up -d

            -   name: Install dependencies
                run: |
                    docker compose -f docker-compose.test.yaml exec -T app composer install --no-interaction --prefer-dist
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console doctrine:migrations:migrate --no-interaction
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console transfer:generate
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:clear --no-warmup
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:warmup

            -   name: Run PHPUnit with coverage
                run: docker compose -f docker-compose.test.yaml exec -T -e XDEBUG_MODE=coverage app vendor/bin/phpunit --coverage-clover coverage.xml

            -   name: Copy coverage from container
                if: always()
                run: docker compose -f docker-compose.test.yaml cp app:/app/coverage.xml ./coverage.xml

            -   name: Upload coverage to Codecov
                uses: codecov/codecov-action@v5
                env:
                    CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

            -   name: Upload coverage XML artifact
                uses: actions/upload-artifact@v4
                if: always()
                with:
                    name: coverage-xml
                    path: coverage.xml
                    retention-days: 7

            -   name: Stop environment
                if: always()
                run: docker compose -f docker-compose.test.yaml down -v

    # ====================================================================
    # DEPLOYMENT SECTION - Configure for your deployment
    # ====================================================================
