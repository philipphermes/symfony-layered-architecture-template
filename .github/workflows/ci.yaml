name: CI/CD

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    build:
        name: Build Docker Images
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Copy env file
                run: cp .env.dist .env

            -   name: Build dev image
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: Dockerfile
                    target: dev
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                        PECL_EXTENSIONS=
                        APK_PACKAGES=postgresql-dev icu-dev libzip-dev git unzip
                    tags: symfony-app:dev
                    load: true
                    cache-from: type=gha,scope=dev-${{ github.ref_name }}
                    cache-to: type=gha,scope=dev-${{ github.ref_name }},mode=max

            -   name: Build prod image
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: Dockerfile
                    target: prod
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                    tags: symfony-app:prod
                    load: true
                    cache-from: type=gha,scope=prod-${{ github.ref_name }}
                    cache-to: type=gha,scope=prod-${{ github.ref_name }},mode=max

    phpstan:
        name: PHPStan
        needs: build
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Copy env file
                run: cp .env.dist .env

            -   name: Build dev image with cache
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: Dockerfile
                    target: dev
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                        PECL_EXTENSIONS=
                        APK_PACKAGES=postgresql-dev icu-dev libzip-dev git unzip
                    tags: symfony-app:dev
                    load: true
                    cache-from: type=gha,scope=dev-${{ github.ref_name }}

            -   name: Start environment
                run: docker compose -f docker-compose.test.yaml up -d

            -   name: Install dependencies
                run: |
                    docker compose -f docker-compose.test.yaml exec -T app composer install --no-interaction --prefer-dist
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console transfer:generate
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:clear --no-warmup
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:warmup

            -   name: Run PHPStan
                run: docker compose -f docker-compose.test.yaml exec -T app vendor/bin/phpstan analyse --memory-limit=1G

            -   name: Stop environment
                if: always()
                run: docker compose -f docker-compose.test.yaml down -v

    deptrac:
        name: Deptrac
        needs: build
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Copy env file
                run: cp .env.dist .env

            -   name: Build dev image with cache
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: Dockerfile
                    target: dev
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                        PECL_EXTENSIONS=
                        APK_PACKAGES=postgresql-dev icu-dev libzip-dev git unzip
                    tags: symfony-app:dev
                    load: true
                    cache-from: type=gha,scope=dev-${{ github.ref_name }}

            -   name: Start environment
                run: docker compose -f docker-compose.test.yaml up -d

            -   name: Install dependencies
                run: |
                    docker compose -f docker-compose.test.yaml exec -T app composer install --no-interaction --prefer-dist
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console transfer:generate
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:clear --no-warmup
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:warmup

            -   name: Run Deptrac
                run: docker compose -f docker-compose.test.yaml exec -T app vendor/bin/deptrac

            -   name: Stop environment
                if: always()
                run: docker compose -f docker-compose.test.yaml down -v

    test:
        name: PHPUnit
        runs-on: ubuntu-latest
        needs: [ deptrac, phpstan ]
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Copy env file
                run: cp .env.dist .env

            -   name: Build dev image with cache
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: Dockerfile
                    target: dev
                    build-args: |
                        FRANKENPHP_VERSION=1.3.4
                        PHP_VERSION=8.4
                        PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
                        PECL_EXTENSIONS=
                        APK_PACKAGES=postgresql-dev icu-dev libzip-dev git unzip
                    tags: symfony-app:dev
                    load: true
                    cache-from: type=gha,scope=dev-${{ github.ref_name }}

            -   name: Start environment
                run: docker compose -f docker-compose.test.yaml up -d

            -   name: Install dependencies
                run: |
                    docker compose -f docker-compose.test.yaml exec -T app composer install --no-interaction --prefer-dist
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console doctrine:migrations:migrate --no-interaction
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console transfer:generate
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:clear --no-warmup
                    docker compose -f docker-compose.test.yaml exec -T app php bin/console cache:warmup

            -   name: Run PHPUnit with coverage
                run: docker compose -f docker-compose.test.yaml exec -T app vendor/bin/phpunit --coverage-clover coverage.xml

            -   name: Copy coverage from container
                if: always()
                run: docker compose -f docker-compose.test.yaml cp app:/app/coverage.xml ./coverage.xml

            -   name: Upload coverage to Codecov
                uses: codecov/codecov-action@v4
                if: always()
                with:
                    files: ./coverage.xml
                    token: ${{ secrets.CODECOV_TOKEN }}
                    fail_ci_if_error: false
                    verbose: true
                    flags: unittests
                    name: codecov-upload

            -   name: Upload coverage XML artifact
                uses: actions/upload-artifact@v4
                if: always()
                with:
                    name: coverage-xml
                    path: coverage.xml
                    retention-days: 7

            -   name: Stop environment
                if: always()
                run: docker compose -f docker-compose.test.yaml down -v

    # ====================================================================
    # DEPLOYMENT SECTION - Uncomment and configure for your deployment
    # ====================================================================

    # deploy-staging:
    #     name: Deploy to Staging
    #     needs: test
    #     runs-on: ubuntu-latest
    #     if: github.ref == 'refs/heads/main'
    #     environment:
    #         name: staging
    #         url: https://staging.yourapp.com
    #     steps:
    #         -   name: Checkout code
    #             uses: actions/checkout@v4
    #
    #         -   name: Set up Docker Buildx
    #             uses: docker/setup-buildx-action@v3
    #
    #         -   name: Login to Container Registry
    #             uses: docker/login-action@v3
    #             with:
    #                 registry: ghcr.io
    #                 username: ${{ github.actor }}
    #                 password: ${{ secrets.GITHUB_TOKEN }}
    #
    #         -   name: Build and push production image
    #             uses: docker/build-push-action@v5
    #             with:
    #                 context: .
    #                 file: Dockerfile
    #                 target: prod
    #                 build-args: |
    #                     FRANKENPHP_VERSION=1.3.4
    #                     PHP_VERSION=8.4
    #                     PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
    #                 tags: |
    #                     ghcr.io/${{ github.repository }}:staging
    #                     ghcr.io/${{ github.repository }}:${{ github.sha }}
    #                 push: true
    #                 cache-from: type=gha,scope=prod-main
    #                 cache-to: type=gha,scope=prod-main,mode=max
    #
    #         -   name: Deploy to staging server
    #             uses: appleboy/ssh-action@v1.0.0
    #             with:
    #                 host: ${{ secrets.STAGING_HOST }}
    #                 username: ${{ secrets.STAGING_USER }}
    #                 key: ${{ secrets.STAGING_SSH_KEY }}
    #                 script: |
    #                     cd /path/to/app
    #                     docker compose pull app
    #                     docker compose down app
    #                     docker compose up -d app
    #
    #                     # Run migrations
    #                     docker compose run --rm app php bin/console doctrine:migrations:migrate --no-interaction
    #
    #                     # Clear cache
    #                     docker compose exec app php bin/console cache:clear
    #
    # deploy-production:
    #     name: Deploy to Production
    #     needs: deploy-staging
    #     runs-on: ubuntu-latest
    #     if: github.ref == 'refs/heads/main'
    #     environment:
    #         name: production
    #         url: https://yourapp.com
    #     steps:
    #         -   name: Checkout code
    #             uses: actions/checkout@v4
    #
    #         -   name: Set up Docker Buildx
    #             uses: docker/setup-buildx-action@v3
    #
    #         -   name: Login to Container Registry
    #             uses: docker/login-action@v3
    #             with:
    #                 registry: ghcr.io
    #                 username: ${{ github.actor }}
    #                 password: ${{ secrets.GITHUB_TOKEN }}
    #
    #         -   name: Build and push production image
    #             uses: docker/build-push-action@v5
    #             with:
    #                 context: .
    #                 file: Dockerfile
    #                 target: prod
    #                 build-args: |
    #                     FRANKENPHP_VERSION=1.3.4
    #                     PHP_VERSION=8.4
    #                     PHP_EXTENSIONS=pdo_pgsql intl zip opcache xml sodium
    #                 tags: |
    #                     ghcr.io/${{ github.repository }}:latest
    #                     ghcr.io/${{ github.repository }}:${{ github.sha }}
    #                 push: true
    #                 cache-from: type=gha,scope=prod-main
    #                 cache-to: type=gha,scope=prod-main,mode=max
    #
    #         -   name: Deploy to production server
    #             uses: appleboy/ssh-action@v1.0.0
    #             with:
    #                 host: ${{ secrets.PRODUCTION_HOST }}
    #                 username: ${{ secrets.PRODUCTION_USER }}
    #                 key: ${{ secrets.PRODUCTION_SSH_KEY }}
    #                 script: |
    #                     cd /path/to/app
    #
    #                     # Pull new image
    #                     docker compose pull app
    #
    #                     # Stop old container
    #                     docker compose down app
    #
    #                     # Start new container
    #                     docker compose up -d app
    #
    #                     # Wait for container to be ready
    #                     sleep 5
    #
    #                     # Run migrations as separate job
    #                     docker compose run --rm app php bin/console doctrine:migrations:migrate --no-interaction
    #
    #                     # Clear cache
    #                     docker compose exec app php bin/console cache:clear
    #
    #                     # Health check
    #                     curl -f http://localhost/health || exit 1
    #
    #         -   name: Notify deployment
    #             if: success()
    #             run: echo "Deployment successful!"
    #             # Add your notification service here (Slack, Discord, email, etc.)
